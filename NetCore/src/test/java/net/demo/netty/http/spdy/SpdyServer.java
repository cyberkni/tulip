package net.demo.netty.http.spdy;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.Channel;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.nio.NioServerSocketChannel;

/**
 * A SPDY Server that responds to a GET request with a Hello World.
 * <p>
 * This class must be run with the JVM parameter:
 * {@code java -Xbootclasspath/p:<path_to_npn_boot_jar> ...}. The
 * "path_to_npn_boot_jar" is the path on the file system for the NPN Boot Jar
 * file which can be downloaded from Maven at coordinates
 * org.mortbay.jetty.npn:npn-boot. Different versions applies to different
 * OpenJDK versions. See <a
 * href="http://www.eclipse.org/jetty/documentation/current/npn-chapter.html"
 * >Jetty docs</a> for more information.
 * <p>
 * Once started, you can test the server with your <a
 * href="http://en.wikipedia.org/wiki/SPDY#Browser_support_and_usage">SPDY
 * enabled web browser</a> by navigating to <a
 * href="https://localhost:8443/">https://localhost:8443/</a>
 */
public class SpdyServer {

	private final int port;

	public SpdyServer(int port) {
		this.port = port;
	}

	public void run() throws Exception {
		// Configure the server.
		EventLoopGroup bossGroup = new NioEventLoopGroup();
		EventLoopGroup workerGroup = new NioEventLoopGroup();
		try {
			ServerBootstrap b = new ServerBootstrap();
			b.option(ChannelOption.SO_BACKLOG, 1024);
			b.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)
					.childHandler(new SpdyServerInitializer());

			Channel ch = b.bind(port).sync().channel();
			ch.closeFuture().sync();
		} finally {
			bossGroup.shutdownGracefully();
			workerGroup.shutdownGracefully();
		}
	}

	public static void main(String[] args) throws Exception {
		int port;
		if (args.length > 0) {
			port = Integer.parseInt(args[0]);
		} else {
			port = 8443;
		}

		System.out.println("SPDY web server started at port " + port + '.');
		System.out.println("Open your SPDY enabled browser and navigate to https://localhost:" + port + '/');
		System.out.println("If using Chrome browser, check your SPDY sessions at chrome://net-internals/#spdy");

		new SpdyServer(port).run();
	}
}
